---
import { getCollection } from 'astro:content';
import { parseRoleMarkdown } from '../utils/cvRoleParser';
import KeyProjectAccordion from '../components/KeyProjectAccordion.astro';

// Load roles from content collection
const allRoles = (await getCollection('experience')).filter((item) => Array.isArray(item.data.visibleIn) && item.data.visibleIn.includes('cv'));

// Sort by recency (most recent first)
const sortedRoles = allRoles.sort((a, b) => {
  const aYear = parseInt(a.data.period.split('—')[0].trim());
  const bYear = parseInt(b.data.period.split('—')[0].trim());
  
  if (aYear === bYear) {
    const aIsPresent = a.data.period.includes('Present');
    const bIsPresent = b.data.period.includes('Present');
    if (aIsPresent && !bIsPresent) return -1;
    if (!aIsPresent && bIsPresent) return 1;
  }
  
  return bYear - aYear;
});

// Parse markdown bodies for each role
const rolesWithParsed = sortedRoles.map((role) => ({
  ...role,
  parsed: parseRoleMarkdown(role.body),
}));

// Skills and education data (preserved from cvData.ts)
const skills = {
  product: ['Product Discovery', 'Roadmap Planning', 'User Research', 'A/B Testing', 'OKRs', 'Product Analytics'],
  technical: ['Python', 'TypeScript', 'React', 'Node.js', 'SQL', 'AWS', 'Blockchain'],
  process: ['Scrum', 'Kanban', 'SAFe', 'Event Storming', 'Story Mapping', 'Design Sprints'],
};

const education = [
  {
    degree: 'MSc Information Technology',
    school: 'Tallinn University of Technology',
    year: '2014',
  },
  {
    degree: 'Certified ScrumMaster (CSM)',
    school: 'Scrum Alliance',
    year: '2020',
  },
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Newsreader:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <title>CV — Jaan Sokk</title>
  </head>
  <body>
    <div class="v2-concept min-h-screen">
      <!-- Header -->
      <header class="border-b border-[var(--v2-border-subtle)] px-6 py-4">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <div class="font-medium">Jaan Sokk</div>
          <nav class="flex items-center gap-6">
            <a href="/" class="text-sm text-[var(--v2-text-secondary)] hover:text-[var(--v2-text)] transition-colors">
              Chat
            </a>
            <a href="/cv" class="text-sm text-[var(--v2-accent)]">
              CV
            </a>
            <a 
              href="https://linkedin.com/in/jaansokk" 
              target="_blank" 
              rel="noopener noreferrer"
              class="text-sm text-[var(--v2-text-secondary)] hover:text-[var(--v2-text)] transition-colors"
            >
              LinkedIn
            </a>
            <a href="/contact" class="text-sm text-[var(--v2-text-secondary)] hover:text-[var(--v2-text)] transition-colors">
              Contact
            </a>
          </nav>
        </div>
      </header>

      <!-- Main Content -->
      <div class="max-w-6xl mx-auto px-6 pt-24 pb-32">
        <div class="flex gap-16">
          <!-- Left: CV Content -->
          <main class="flex-1 min-w-0">
            <!-- Header / About -->
            <section class="mb-16">
              <h1 class="text-4xl md:text-5xl font-medium mb-2">
                Jaan <span class="v2-serif text-[var(--v2-accent)]">Sokk</span>
              </h1>
              <p class="text-xl text-[var(--v2-text-secondary)] mb-6">
                Product Manager & Technical Lead
              </p>
              <p class="text-[var(--v2-text-secondary)] max-w-2xl leading-relaxed">
                A hands-on product leader who can balance strategic vision with tactical execution, 
                work closely with engineering teams, and drive results through data and user feedback 
                rather than just process. 10+ years across fintech, blockchain, gaming, and mobility.
              </p>
            </section>

            <!-- Experience -->
            <section id="experience" class="mb-16">
              <h2 class="text-xs uppercase tracking-wider text-[var(--v2-text-tertiary)] mb-8 font-medium">
                Experience
              </h2>
              <div class="space-y-8">
                {rolesWithParsed.map((role, idx) => (
                  <article 
                    id={role.id}
                    class="group scroll-mt-24"
                  >
                    <div class="relative pl-6 pb-12 border-l border-[var(--v2-border-subtle)] last:pb-0">
                      <!-- Timeline dot -->
                      <div class="absolute -left-[5px] top-1 w-[9px] h-[9px] rounded-full bg-[var(--v2-accent)] opacity-60 group-hover:opacity-100 transition-opacity" />
                      
                      <!-- Header -->
                      <div class="mb-4">
                        <div class="flex items-start justify-between gap-4 flex-wrap">
                          <div>
                            <h3 class="text-lg font-medium text-[var(--v2-text)]">
                              {role.data.title}
                            </h3>
                            <p class="text-[var(--v2-accent)] font-medium">
                              {role.data.company}
                            </p>
                          </div>
                          <span class="text-sm text-[var(--v2-text-tertiary)] font-mono whitespace-nowrap">
                            {role.data.period}
                          </span>
                        </div>
                        
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2 mt-3">
                          {role.data.tags.map((tag) => (
                            <span 
                              class="px-2 py-0.5 text-xs bg-[var(--v2-accent-dim)] text-[var(--v2-accent)] rounded"
                            >
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                      
                      <!-- Summary -->
                      <p class="text-[var(--v2-text-secondary)] mb-4 leading-relaxed">
                        {role.data.summary}
                      </p>
                      
                      <!-- Impact -->
                      {role.parsed.impact.length > 0 && (
                        <div class="mb-4">
                          <h4 class="text-xs font-semibold text-[var(--v2-accent)] mb-2">Impact:</h4>
                          <ul class="space-y-2">
                            {role.parsed.impact.map((bullet) => (
                              <li class="flex items-start gap-3 text-sm text-[var(--v2-text-secondary)]">
                                <span class="text-[var(--v2-accent)] mt-1.5 text-[8px]">●</span>
                                <span>{bullet}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                      
                      <!-- Context -->
                      {role.parsed.context.length > 0 && (
                        <div class="mb-4">
                          <h4 class="text-xs font-semibold text-[var(--v2-accent)] mb-2">Context:</h4>
                          <ul class="space-y-1">
                            {role.parsed.context.map((bullet) => (
                              <li class="flex items-start gap-3 text-sm text-[var(--v2-text-secondary)]">
                                <span class="text-[var(--v2-accent)] mt-1.5 text-[8px]">●</span>
                                <span>{bullet}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                      
                      <!-- Key Projects (Accordion) -->
                      <KeyProjectAccordion projects={role.parsed.keyProjects} roleSlug={role.id} />
                    </div>
                  </article>
                ))}
              </div>
            </section>

            <!-- Skills -->
            <section id="skills" class="mb-16">
              <h2 class="text-xs uppercase tracking-wider text-[var(--v2-text-tertiary)] mb-8 font-medium">
                Skills
              </h2>
              <div class="grid md:grid-cols-3 gap-8">
                <div>
                  <h3 class="text-sm font-medium text-[var(--v2-text)] mb-3">Product</h3>
                  <ul class="space-y-1.5">
                    {skills.product.map((skill) => (
                      <li class="text-sm text-[var(--v2-text-secondary)]">{skill}</li>
                    ))}
                  </ul>
                </div>
                <div>
                  <h3 class="text-sm font-medium text-[var(--v2-text)] mb-3">Technical</h3>
                  <ul class="space-y-1.5">
                    {skills.technical.map((skill) => (
                      <li class="text-sm text-[var(--v2-text-secondary)]">{skill}</li>
                    ))}
                  </ul>
                </div>
                <div>
                  <h3 class="text-sm font-medium text-[var(--v2-text)] mb-3">Process</h3>
                  <ul class="space-y-1.5">
                    {skills.process.map((skill) => (
                      <li class="text-sm text-[var(--v2-text-secondary)]">{skill}</li>
                    ))}
                  </ul>
                </div>
              </div>
            </section>

            <!-- Education -->
            <section id="education" class="mb-16">
              <h2 class="text-xs uppercase tracking-wider text-[var(--v2-text-tertiary)] mb-8 font-medium">
                Education & Certifications
              </h2>
              <div class="space-y-4">
                {education.map((edu) => (
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <p class="font-medium text-[var(--v2-text)]">{edu.degree}</p>
                      <p class="text-sm text-[var(--v2-text-secondary)]">{edu.school}</p>
                    </div>
                    <span class="text-sm text-[var(--v2-text-tertiary)] font-mono">{edu.year}</span>
                  </div>
                ))}
              </div>
            </section>
          </main>
          
          <!-- Right: Table of Contents - sticky -->
          <aside class="hidden lg:block w-48 flex-shrink-0">
            <div class="sticky top-24">
              <nav>
                <h3 class="text-xs uppercase tracking-wider text-[var(--v2-text-tertiary)] mb-4 font-medium">
                  On this page
                </h3>
                <ul class="space-y-1">
                  {rolesWithParsed.map((role) => (
                    <li>
                      <a
                        href={`#${role.id}`}
                        class="group flex items-center gap-3 py-1.5 text-sm text-[var(--v2-text-secondary)] hover:text-[var(--v2-text)] transition-colors"
                      >
                        <span class="w-1 h-1 rounded-full bg-[var(--v2-text-tertiary)] group-hover:bg-[var(--v2-accent)] transition-colors" />
                        <span class="truncate">{role.data.company}</span>
                      </a>
                    </li>
                  ))}
                </ul>
                
                <div class="mt-8 pt-6 border-t border-[var(--v2-border-subtle)]">
                  <ul class="space-y-1">
                    <li>
                      <a
                        href="#skills"
                        class="text-sm text-[var(--v2-text-tertiary)] hover:text-[var(--v2-text-secondary)] transition-colors"
                      >
                        Skills
                      </a>
                    </li>
                    <li>
                      <a
                        href="#education"
                        class="text-sm text-[var(--v2-text-tertiary)] hover:text-[var(--v2-text-secondary)] transition-colors"
                      >
                        Education
                      </a>
                    </li>
                  </ul>
                </div>
              </nav>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </body>
</html>

<style is:global>
  @tailwind base;
  @tailwind components;
  @tailwind utilities;
  
  :root {
    --v2-bg: #0a0a0a;
    --v2-bg-elevated: #141414;
    --v2-bg-card: #1a1a1a;
    --v2-text: #e6e6e6;
    --v2-text-secondary: #9f9f9f;
    --v2-text-tertiary: #616161;
    --v2-accent: #a4c6be;
    --v2-accent-dim: rgba(164, 198, 190, 0.15);
    --v2-border: #2a2a2a;
    --v2-border-subtle: #1e1e1e;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: var(--v2-bg);
    color: var(--v2-text);
    line-height: 1.6;
  }
  
  .v2-concept {
    font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--v2-bg);
    color: var(--v2-text);
    min-height: 100vh;
  }
  
  .v2-serif {
    font-family: 'Newsreader', Georgia, serif;
    font-style: italic;
  }

  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }
</style>

<style is:global>
  @tailwind base;
  @tailwind components;
  @tailwind utilities;
  
  :root {
    --v2-bg: #0a0a0a;
    --v2-bg-elevated: #141414;
    --v2-bg-card: #1a1a1a;
    --v2-text: #e6e6e6;
    --v2-text-secondary: #9f9f9f;
    --v2-text-tertiary: #616161;
    --v2-accent: #a4c6be;
    --v2-accent-dim: rgba(164, 198, 190, 0.15);
    --v2-border: #2a2a2a;
    --v2-border-subtle: #1e1e1e;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    background: var(--v2-bg);
    color: var(--v2-text);
    line-height: 1.6;
  }
  
  .v2-concept {
    font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--v2-bg);
    color: var(--v2-text);
    min-height: 100vh;
  }
  
  .v2-serif {
    font-family: 'Newsreader', Georgia, serif;
    font-style: italic;
  }
  
  @keyframes v2-fade-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes v2-fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes v2-scale-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  
  @keyframes v2-pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  @keyframes v2-slide-up {
    from { opacity: 0; transform: translateY(100%); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes v2-slide-in-right {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
  
  .animate-fade-up {
    animation: v2-fade-up 0.6s ease-out forwards;
  }
  
  .animate-fade-in {
    animation: v2-fade-in 0.5s ease-out forwards;
  }
  
  .animate-scale-in {
    animation: v2-scale-in 0.4s ease-out forwards;
  }
  
  .animate-pulse-subtle {
    animation: v2-pulse-subtle 2s ease-in-out infinite;
  }
  
  .animate-slide-up {
    animation: v2-slide-up 0.3s ease-out forwards;
  }
  
  .animate-slide-in-right {
    animation: v2-slide-in-right 0.3s ease-out forwards;
  }

  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }
</style>

