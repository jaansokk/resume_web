---
import type { KeyProject } from '../../utils/cvRoleParser';

interface Props {
  projects: KeyProject[];
  roleSlug: string;
}

const { projects, roleSlug } = Astro.props;

/**
 * Simple markdown renderer that:
 * - Treats **Heading:** lines as styled subheadings
 * - Converts _italic_ to <em>
 * - Converts **bold** to <strong>
 * - Preserves bullet points
 */
function renderMarkdown(content: string): string {
  if (!content) return '';
  
  const lines = content.split('\n');
  const html: string[] = [];
  let inList = false;
  
  for (let line of lines) {
    const trimmed = line.trim();
    
    // Empty lines
    if (!trimmed) {
      if (inList) {
        html.push('</ul>');
        inList = false;
      }
      continue;
    }
    
    // Check for **Heading** or **Heading:** pattern (subheading)
    const headingMatch = trimmed.match(/^\*\*([^*]+)\*\*\s*$/);
    if (headingMatch) {
      if (inList) {
        html.push('</ul>');
        inList = false;
      }
      // Remove trailing colon if present
      const heading = headingMatch[1].trim().replace(/:$/, '');
      html.push(`<p class="section-label">${heading}</p>`);
      continue;
    }
    
    // Check for bullet points
    const bulletMatch = trimmed.match(/^[-*]\s+(.+)$/);
    if (bulletMatch) {
      if (!inList) {
        html.push('<ul class="bullet-list">');
        inList = true;
      }
      const bulletContent = processInlineMarkdown(bulletMatch[1]);
      html.push(`<li><span class="bullet">â€¢</span><span>${bulletContent}</span></li>`);
      continue;
    }
    
    // Regular paragraph
    if (inList) {
      html.push('</ul>');
      inList = false;
    }
    const processed = processInlineMarkdown(trimmed);
    html.push(`<p>${processed}</p>`);
  }
  
  // Close any open list
  if (inList) {
    html.push('</ul>');
  }
  
  return html.join('');
}

/**
 * Process inline markdown (italics, bold)
 */
function processInlineMarkdown(text: string): string {
  // Convert [text](url) to links with basic safety checks
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_match, label, href) => {
    const safeHref = normalizeUrl(href);
    if (!safeHref) {
      return label;
    }
    const external = isExternalUrl(safeHref);
    const target = external ? ' target="_blank"' : '';
    const rel = external ? ' rel="noreferrer"' : '';
    return `<a href="${safeHref}"${target}${rel}>${label}</a>`;
  });

  // Convert _italic_ or *italic* to <em>
  text = text.replace(/_(.*?)_/g, '<em>$1</em>');
  text = text.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  
  // Convert **bold** to <strong> (but not if it's part of **Heading:** which we already handled)
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  
  return text;
}

function normalizeUrl(raw: string): string | null {
  if (!raw) return null;
  const trimmed = raw.trim();
  if (!trimmed) return null;
  if (trimmed.startsWith('/') || trimmed.startsWith('#')) {
    return trimmed;
  }
  try {
    const parsed = new URL(trimmed);
    if (parsed.protocol === 'http:' || parsed.protocol === 'https:' || parsed.protocol === 'mailto:') {
      return trimmed;
    }
  } catch {
    return null;
  }
  return null;
}

function isExternalUrl(href: string): boolean {
  return href.startsWith('http://') || href.startsWith('https://');
}
---

{projects.length > 0 && (
  <div class="key-projects-section">
    <div class="key-projects-header">
      <h4 class="text-xs uppercase tracking-wider text-[var(--v2-text-tertiary)] font-medium">
        Key Projects
      </h4>
      <button
        type="button"
        class="toggle-all-btn"
        data-role={roleSlug}
        data-expanded="false"
        aria-label="Toggle all projects"
      >
        <span class="toggle-label">Expand all</span>
        <svg class="toggle-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
          <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="projects-list">
      {projects.map((project, idx) => {
        const projectId = `${roleSlug}-project-${idx}`;
        const panelId = `${projectId}-panel`;
        
        return (
          <div class="project-accordion" data-role={roleSlug}>
            <button
              type="button"
              class="accordion-trigger"
              aria-expanded="false"
              aria-controls={panelId}
              id={projectId}
            >
              <svg class="accordion-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
                <path d="M4.5 2.5L8 6L4.5 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="project-title">{project.title}</span>
            </button>
            
            <div
              class="accordion-panel"
              id={panelId}
              role="region"
              aria-labelledby={projectId}
              hidden
            >
              <div class="panel-content">
                {project.content && (
                  <div class="project-content" set:html={renderMarkdown(project.content)} />
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </div>
)}

<style>
  .key-projects-section {
    margin-top: 0.75rem;
  }

  .key-projects-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .key-projects-header h4 {
    margin: 0;
  }

  .toggle-all-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0;
    background: transparent;
    border: none;
    color: var(--v2-text-tertiary);
    font-size: 0.75rem;
    cursor: pointer;
    transition: color 0.15s ease;
  }

  .toggle-all-btn:hover {
    color: var(--v2-text-secondary);
  }

  .toggle-icon {
    transition: transform 0.2s ease;
  }

  .toggle-all-btn[data-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
  }

  .projects-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .project-accordion {
    border-bottom: 1px solid var(--v2-border-subtle);
  }

  .project-accordion:last-child {
    border-bottom: none;
  }

  .accordion-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.5rem;
    padding: 0.5rem 0;
    background: transparent;
    border: none;
    color: var(--v2-text-secondary);
    cursor: pointer;
    transition: color 0.15s ease;
    text-align: left;
  }

  .accordion-trigger:hover {
    color: var(--v2-text);
  }

  .accordion-trigger:hover .accordion-chevron {
    color: var(--v2-text-secondary);
  }

  .project-title {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 400;
    line-height: 1.5;
  }

  .accordion-chevron {
    flex-shrink: 0;
    color: var(--v2-text-tertiary);
    transition: transform 0.2s ease, color 0.15s ease;
  }

  .accordion-trigger[aria-expanded="true"] .accordion-chevron {
    transform: rotate(90deg);
    color: var(--v2-accent);
  }

  .accordion-panel {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.2s ease;
  }

  .accordion-panel[hidden] {
    display: grid;
  }

  .panel-content {
    overflow: hidden;
  }

  .accordion-panel:not([hidden]) {
    grid-template-rows: 1fr;
  }

  .accordion-panel:not([hidden]) .panel-content {
    padding: 0 0 0.75rem 1.25rem;
  }

  .project-content {
    font-size: 0.875rem;
    color: var(--v2-text-secondary);
    line-height: 1.5;
  }

  .project-content p {
    margin: 0 0 0.5rem 0;
  }

  .project-content p:last-child {
    margin-bottom: 0;
  }

  .project-content em {
    font-style: italic;
  }

  .project-content strong {
    font-weight: 600;
  }

  .project-content a {
    color: var(--v2-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.15s ease;
  }

  .project-content a:hover {
    color: var(--v2-text);
  }

  .project-content :global(.section-label) {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--v2-accent);
    margin: 0.75rem 0 0.375rem 0;
  }

  .project-content :global(.section-label:first-child) {
    margin-top: 0;
  }

  .project-content :global(.bullet-list) {
    list-style: none;
    margin: 0 0 0.5rem 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .project-content :global(.bullet-list li) {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .project-content :global(.bullet) {
    color: var(--v2-accent);
    font-size: 0.5rem;
    margin-top: 0.5rem;
    flex-shrink: 0;
  }
</style>

<script>
  // Accordion toggle functionality
  function initializeAccordions() {
    // Helper to update toggle button state
    function updateToggleButton(btn: Element, roleSlug: string) {
      const accordions = document.querySelectorAll(`.project-accordion[data-role="${roleSlug}"]`);
      const allExpanded = Array.from(accordions).every((accordion) => {
        const trigger = accordion.querySelector('.accordion-trigger');
        return trigger?.getAttribute('aria-expanded') === 'true';
      });
      
      btn.setAttribute('data-expanded', String(allExpanded));
      const label = btn.querySelector('.toggle-label');
      if (label) {
        label.textContent = allExpanded ? 'Collapse all' : 'Expand all';
      }
    }

    // Individual accordion toggles
    const triggers = document.querySelectorAll('.accordion-trigger');
    triggers.forEach((trigger) => {
      // Remove existing listener if any (to avoid duplicates)
      const oldListener = (trigger as any)._accordionListener;
      if (oldListener) {
        trigger.removeEventListener('click', oldListener);
      }
      
      // Create new listener
      const listener = () => {
        const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
        const panelId = trigger.getAttribute('aria-controls');
        const panel = document.getElementById(panelId!);
        
        if (panel) {
          trigger.setAttribute('aria-expanded', String(!isExpanded));
          panel.hidden = isExpanded;
          
          // Update the toggle-all button state
          const accordion = trigger.closest('.project-accordion');
          const roleSlug = accordion?.getAttribute('data-role');
          if (roleSlug) {
            const toggleBtn = document.querySelector(`.toggle-all-btn[data-role="${roleSlug}"]`);
            if (toggleBtn) {
              updateToggleButton(toggleBtn, roleSlug);
            }
          }
        }
      };
      
      // Store listener reference and add it
      (trigger as any)._accordionListener = listener;
      trigger.addEventListener('click', listener);
    });

    // Toggle all buttons
    const toggleAllBtns = document.querySelectorAll('.toggle-all-btn');
    toggleAllBtns.forEach((btn) => {
      // Remove existing listener if any (to avoid duplicates)
      const oldListener = (btn as any)._toggleAllListener;
      if (oldListener) {
        btn.removeEventListener('click', oldListener);
      }
      
      // Create new listener
      const listener = () => {
        const roleSlug = btn.getAttribute('data-role');
        if (!roleSlug) return;
        
        const isCurrentlyExpanded = btn.getAttribute('data-expanded') === 'true';
        const accordions = document.querySelectorAll(`.project-accordion[data-role="${roleSlug}"]`);
        
        accordions.forEach((accordion) => {
          const trigger = accordion.querySelector('.accordion-trigger');
          const panelId = trigger?.getAttribute('aria-controls');
          const panel = panelId ? document.getElementById(panelId) : null;
          
          if (trigger && panel) {
            trigger.setAttribute('aria-expanded', String(!isCurrentlyExpanded));
            panel.hidden = isCurrentlyExpanded;
          }
        });
        
        // Update button state
        btn.setAttribute('data-expanded', String(!isCurrentlyExpanded));
        const label = btn.querySelector('.toggle-label');
        if (label) {
          label.textContent = isCurrentlyExpanded ? 'Expand all' : 'Collapse all';
        }
      };
      
      // Store listener reference and add it
      (btn as any)._toggleAllListener = listener;
      btn.addEventListener('click', listener);
    });
  }

  // Initialize on both DOMContentLoaded (first load) and astro:page-load (client-side navigation)
  document.addEventListener('DOMContentLoaded', initializeAccordions);
  document.addEventListener('astro:page-load', initializeAccordions);
</script>
